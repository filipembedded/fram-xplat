FRAM_Status_TypeDef FRAM_Write(FRAM_Instance_TypeDef *fram, uint8_t *address, uint8_t *data, uint16_t size)
{
    FRAM_Status_TypeDef status = FRAM_STATUS_SUCCESS;
    uint8_t cmd;
    uint8_t addr_buf[3];

    // 1️⃣ Enable write latch
    cmd = FRAM_OPCODE_WREN;
    fram->spi_chip_select(fram->context);
    if (fram->spi_write(fram->context, &cmd, 1) != 0) {
        status = FRAM_STATUS_ERROR;
        goto cleanup;
    }
    fram->spi_chip_deselect(fram->context);

    // 2️⃣ Prepare WRITE command and address
    cmd = FRAM_OPCODE_WRITE;
    addr_buf[0] = (address[0] & 0x07); // upper 5 bits ignored — 19-bit addressing
    addr_buf[1] = address[1];
    addr_buf[2] = address[2];

    // 3️⃣ Start WRITE sequence
    fram->spi_chip_select(fram->context);

    // Send WRITE opcode
    if (fram->spi_write(fram->context, &cmd, 1) != 0) {
        status = FRAM_STATUS_ERROR;
        goto cleanup_deselect;
    }

    // Send 3-byte address
    if (fram->spi_write(fram->context, addr_buf, 3) != 0) {
        status = FRAM_STATUS_ERROR;
        goto cleanup_deselect;
    }

    // Send data payload
    if (fram->spi_write(fram->context, data, size) != 0) {
        status = FRAM_STATUS_ERROR;
        goto cleanup_deselect;
    }

cleanup_deselect:
    fram->spi_chip_deselect(fram->context);

cleanup:
    return status;
}
